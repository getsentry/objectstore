name: CI / Python

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2
        with:
          version: '0.9.3'
          enable-cache: false # we just cache the venv-dir directly in action-setup-venv

      - uses: getsentry/action-setup-venv@0958463ee0e02b9e8aa8f8e031afae1f84b80881 # v3.0.0
        with:
          cache-dependency-path: uv.lock
          install-cmd: uv sync --all-packages --all-groups --frozen --active

      - name: Run black
        run: black --check --diff python-objectstore-client

      - name: Run isort
        run: isort --check-only --diff python-objectstore-client

      - name: Run flake8
        run: flake8 python-objectstore-client

      - name: Run mypy
        run: mypy python-objectstore-client

  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2
        with:
          version: '0.9.3'
          enable-cache: false # we just cache the venv-dir directly in action-setup-venv

      - uses: getsentry/action-setup-venv@0958463ee0e02b9e8aa8f8e031afae1f84b80881 # v3.0.0
        with:
          cache-dependency-path: uv.lock
          install-cmd: uv sync --all-packages --all-groups --frozen --active

      - name: Run tests
        run: pytest python-objectstore-client
